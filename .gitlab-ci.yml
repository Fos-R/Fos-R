stages:
  - build
  - test
  - analyze
  - deploy

build:
  tags:
    - ci.inria.fr
    - large
  stage: build
  image: rust
  script:
    - apt update
    # version without network injection
    - cargo build --no-default-features -p fosr
    # version without ebpf and with iptables
    - cargo build --no-default-features --features iptables -p fosr
    # version with ebpf
    - rustup toolchain install nightly --component rust-src
    - cargo install bpf-linker
    - cargo build --features iptables # version with ebpf + iptables
    - cargo build # version with ebpf only
    - cargo build --release
    - cargo doc --no-deps
    - mv target/doc doc
    - cargo install cargo-deb
    - cargo deb -p fosr
    # cross-compilation (x86 32 bits)
    - apt install -y gcc-i686-linux-gnu
    - rustup target add i686-unknown-linux-gnu
    # Aya doesnâ€™t compile for some reason
    - cargo build --target=i686-unknown-linux-gnu --config target.i686-unknown-linux-gnu.linker=\"i686-linux-gnu-gcc\" -p fosr -r --no-default-features
    - cargo deb --target=i686-unknown-linux-gnu -p fosr --no-default-features -- --config target.i686-unknown-linux-gnu.linker=\"i686-linux-gnu-gcc\"
    # cross-compilation (arm 32 bits with musl)
    - apt install -y gcc-arm-linux-gnueabihf
    - rustup target add arm-unknown-linux-musleabihf
    - cargo build --target=arm-unknown-linux-musleabihf --config target.arm-unknown-linux-musleabihf.linker=\"arm-linux-gnueabihf-gcc\" -p fosr -r
    - cargo deb --target=arm-unknown-linux-musleabihf -p fosr -- --config target.arm-unknown-linux-musleabihf.linker=\"arm-linux-gnueabihf-gcc\"
    # cross-compilation (arm 64 bits with libc)
    - apt install -y gcc-aarch64-linux-gnu
    - rustup target add aarch64-unknown-linux-gnu
    - cargo build --target=aarch64-unknown-linux-gnu --config target.aarch64-unknown-linux-gnu.linker=\"aarch64-linux-gnu-gcc\" -p fosr -r
    - cargo deb --target=aarch64-unknown-linux-gnu -p fosr -- --config target.aarch64-unknown-linux-gnu.linker=\"aarch64-linux-gnu-gcc\"
    # cross-compilation (windows, WIP)
    # - apt install -y binutils-mingw-w64-x86-64 gcc-mingw-w64
    # - rustup target add x86_64-pc-windows-gnu
    # - cargo build --target=x86_64-pc-windows-gnu -p fosr -r --no-default-features
    # cross-compilation (FreedBSD, WIP)
    # - rustup target add x86_64-unknown-freebsd
    # - cargo build --target=x86_64-unknown-freebsd --config target.x86_64-unknown-freebsd.linker=\"arm-linux-gnueabihf-gcc\" -p fosr -r
    - mkdir target/x86_64-unknown-linux-gnu
    - mv target/release target/x86_64-unknown-linux-gnu
  artifacts:
    paths:
      - target/*/release/fosr
      - target/debian/*.deb
      - doc

tests:
  tags:
    - ci.inria.fr
    - large
  stage: test
  image: rust
  rules:
    # other branch may have outdated tests
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  script:
    # generation only, so no need for ebpf
    - cargo test -p fosr --no-default-features -- --nocapture
    - mv crates/fosr/deterministic-test.pcap sample.pcap
  artifacts:
    paths:
      - sample.pcap

eval-zeek:
  image: zeek/zeek
  tags:
    - ci.inria.fr
    - small
  stage: analyze
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  script:
    - mkdir analysis-zeek
    - cd analysis-zeek
    - zeek -r ../sample.pcap
  artifacts:
    paths:
      - analysis-zeek

eval-tshark:
  image: alpine
  tags:
    - ci.inria.fr
    - small
  stage: analyze
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  script:
    - apk add tshark
    - mkdir analysis-tshark
    - capinfos sample.pcap > analysis-tshark/capinfos.txt
    - tshark -r sample.pcap > analysis-tshark/summary_per_pkt.txt
    - tshark -r sample.pcap -z expert -q > analysis-tshark/expert.txt
    - tshark -r sample.pcap -z conv,ip -q > analysis-tshark/conv_ip.txt
    - tshark -r sample.pcap -z conv,udp -q > analysis-tshark/conv_udp.txt
    - tshark -r sample.pcap -z conv,tcp -q > analysis-tshark/conv_tcp.txt
  artifacts:
    paths:
      - analysis-tshark

eval-suricata:
  image: alpine
  tags:
    - ci.inria.fr
    - small
  stage: analyze
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  script:
    - apk add suricata
    - mkdir analysis-suricata
    - cd analysis-suricata
    - suricata -c /etc/suricata/suricata.yaml -r ../sample.pcap > analysis.txt
  artifacts:
    paths:
      - analysis-suricata


pages:
  image: alpine
  tags:
    - ci.inria.fr
    - small
  stage: deploy
  pages:
    publish: public
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  script:
    - apk add pandoc
    - mv doc public/
    - mv target public/bin
    - mv analysis* public/
    - mv sample.pcap public/
    - cp resources/logo.png public/
    - cd public
    - echo -e "\n## Binaries\n" > binaries.md
    - find "bin" -type f -name "fosr" -exec echo "- [{}]({})" \; >> binaries.md
    - echo -e "\n## .deb packages\n" >> binaries.md
    - find "bin" -type f -name "*.deb" -exec echo "- [{}]({})" \; >> binaries.md
    - echo -e "\n## Analyzed pcap sample\n" > analysis.md
    - find . -type f -name "*.pcap" -exec echo "- [{}]({})" \; >> analysis.md
    - echo -e "\n## Zeek analysis\n" >> analysis.md
    - find "analysis-zeek" -type f -exec echo "- [{}]({})" \; >> analysis.md
    - echo -e "\n## TShark analysis\n" >> analysis.md
    - find "analysis-tshark" -type f -exec echo "- [{}]({})" \; >> analysis.md
    - echo -e "\n## Suricata analysis\n" >> analysis.md
    - find "analysis-suricata" -type f -exec echo "- [{}]({})" \; >> analysis.md
    - pandoc intro.md binaries.md compile.md howto.md roadmap.md usecases.md analysis-intro.md analysis.md refs.md -o index.html --template template.html --include-after-body footer.html --standalone --no-highlight --toc --toc-depth 1 --mathjax
  artifacts:
    paths:
      - public

